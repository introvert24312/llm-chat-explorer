<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Chat Explorer</title>
  <meta name="description" content="LLM Chat Explorer is a web application that allows you to view and analyze conversation exports from ChatGPT and Claude, offering an intuitive interface to manage chat history.">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/marked@4.3.0/marked.min.js"></script>
  <style>
    :root {
      --primary-color: #10a37f;
      --primary-light: #e6f7f2;
      --text-color: #343541;
      --text-light: #8e8ea0;
      --sidebar-bg: #f7f7f8;
      --content-bg: #ffffff;
      --border-color: #e5e5e6;
      --hover-color: #f0f0f0;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      --radius: 8px;
      --highlight-bg: rgba(16, 163, 127, 0.2); /* Highlight color in light mode */
    }
    /* Dark mode override */
    body.dark-mode {
      --primary-color: #10a37f;
      --primary-light: #0e8a69;
      --text-color: #f0f0f0;
      --text-light: #aaa;
      --sidebar-bg: #1e1e1e;
      --content-bg: #121212;
      --border-color: #333;
      --hover-color: #2a2a2a;
      --shadow: none;
      --highlight-bg: rgba(218, 15, 127, 0.8); /* More intense highlight in dark mode. Was rgba(16, 163, 127, 0.4) */
    }

    body.dark-mode .code-block {
        background-color: #2b2b2b;
        color: #f8f8f2;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: var(--text-color);
      background-color: var(--content-bg);
      line-height: 1.6;
      transition: background-color 0.3s, color 0.3s;
    }
    
    /* Upload wrapper to vertically center */
    #upload-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      padding: 20px;
    }
    
    /* Upload area: smaller with border and centered */
    #upload-area {
      cursor: pointer;
      border: 2px dashed #ccc;
      border-radius: var(--radius);
      padding: 40px;
      text-align: center;
      max-width: 400px;
      width: 100%;
      transition: background-color 0.3s, border-color 0.3s;
    }
    #upload-area.hover {
      background-color: #f0f0f0;
      border-color: var(--primary-color);
    }
    /* Upload title with inline icon */
    .upload-title {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1.5rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      white-space: nowrap;
    }
    .upload-title i {
      font-size: 1.8rem;
    }
    /* General text inside #upload-area */
    #upload-area p {
      font-size: 1.2rem;
      color: var(--text-color);
    }

    /* Smaller text for description */
    #upload-area p.small-text {
      font-size: 0.8rem;
    }

    /* Default style for instruction text */
    #upload-area p.upload-instruction {
      font-size: 1rem;  /* Font size */
      color: var(--text-color); /* Use theme variable */
      margin-top: 10px;  /* Space above */
      text-align: center; /* Centered text */
      line-height: 1.5; /* Improve readability */
    }
    
    /* Progress bar */
    #loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: #eee;
      z-index: 9999;
      display: none;
    }
    #loading-bar {
      height: 100%;
      width: 0%;
      background-color: var(--primary-color);
      transition: width 0.2s;
    }
    
    /* App container */
    .app-container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    .sidebar {
      width: 320px;
      background-color: var(--sidebar-bg);
      border-right: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      transition: width 0.3s ease;
    }
    
    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .sidebar-header h1 {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      font-size: 1.2rem; /* 1.5rem */
      color: var(--primary-color);
      white-space: nowrap;
    }
    
    #chat-counter {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: var(--text-light);
      padding: 5px 20px; /* 20px left and right */
    }

    .chat-info {
      display: flex;
      align-items: center;
      gap: 5px; /* Space between icon and text */
    }

    /* Gear icon to open settings */
    #open-settings {
      cursor: pointer;
      font-size: 0.9rem;
    }

    
    .search-container {
      position: relative;
      margin: 15px 20px;
    }

    .search-options {
      position: relative;
      margin: 1px 20px;
      font-size: 0.8rem;
      padding: 0px 0px 10px 0px;
      border-bottom: 1px solid var(--border-color);
    }
    
    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-light);
    }
    
    #search-bar {
      width: 100%;
      padding: 10px 40px 10px 40px;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      font-size: 14px;
      transition: all 0.2s ease;
      background-color: var(--content-bg);
    }
    
    #search-bar:focus {
      outline: none;
      border-color: var (--primary-color);
      box-shadow: 0 0 0 2px rgba(16, 163, 127, 0.2);
    }
    
    .clear-search {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 14px;
      color: var(--text-color);
      cursor: pointer;
      display: none;
      width: 18px;
      height: 18px;
      line-height: 18px;
      text-align: center;
      border: none;
      border-radius: 50%;
      background-color: #d3d3d3;
    }
    .clear-search:hover {
      background-color: #c0c0c0;
      color: var(--primary-color);
    }
    
    .chat-list {
      list-style: none;
      overflow-y: auto;
      flex-grow: 1;
      padding: 10px;
    }
    
    .chat-list li {
      padding: 12px 15px;
      margin-bottom: 5px;
      cursor: pointer;
      border-radius: var(--radius);
      transition: all 0.2s ease;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-left: 3px solid transparent;
    }
    
    .chat-list li:hover {
      background-color: var(--hover-color);
      border-left-color: var(--primary-color);
    }
    
    .chat-list li.active {
      background-color: var(--primary-light);
      border-left-color: var(--primary-color);
      font-weight: 500;
    }
    
    .chat-date {
      color: var(--text-light);
      font-size: 0.8rem;
      margin-left: 5px;
      opacity: 0.7;
    }
    
    .content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .content-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      border-bottom: 1px solid var(--border-color);
      background-color: var(--content-bg);
      box-shadow: var(--shadow);
    }
    
    .content-header h2 {
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .external-link {
      display: inline-flex;
      align-items: center;
      gap: 5px; /* Set a 5px space between icon and text */
      color: var(--primary-color);
      text-decoration: none;
      font-size: 14px;
      transition: opacity 0.2s;
      padding: 6px 12px;
      border-radius: var(--radius);
      background-color: var(--primary-light);
    }
    /* In dark mode, the link text becomes white */
    body.dark-mode .external-link {
      color: #ffffff;
    }
    /* In dark mode, the text typed in the search field will be the variable like --text-color(#f0f0f0) instead of plain white */
    body.dark-mode #search-bar {
      color: var(--text-color);
    }
    body.dark-mode .clear-search {
      color: #333; /* Dark color for the X in dark mode */
    }

    .external-link:hover {
      opacity: 0.8;
    }
    
    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 20px 30px;
      background-color: var(--content-bg);
    }
    
    .message {
      margin-bottom: 20px;
      padding: 15px;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: relative;
    }
    
    .message-user {
      background-color: var(--primary-light);
      margin-left: 50px;
    }
    
    .message-assistant {
      background-color: var(--sidebar-bg);
      margin-right: 50px;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background-color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      margin-right: 10px;
      font-size: 14px;
    }
    
    .sender {
      font-weight: 600;
      font-size: 14px;
    }
    
    .message-content {
      line-height: 1.6;
    }
    
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-light);
      text-align: center;
    }
    
    .empty-state i {
      font-size: 3rem;
      margin-bottom: 20px;
    }
    
    .empty-state p {
      font-size: 1.1rem;
    }
    
    @media (max-width: 768px) {
      .app-container {
        flex-direction: column;
      }
      
      .sidebar {
        width: 100%;
        height: 50vh;
        min-height: 200px;
      }
      
      .content {
        height: 50vh;
      }
    }
    
    /* ---------- Settings modal ---------- */
    #settings-modal {
      display: none;
      position: fixed;
      z-index: 10000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.5);
      justify-content: center;
      align-items: center;
    }
    #settings-modal .modal-content {
      background-color: var(--content-bg);
      padding: 20px;
      border-radius: var(--radius);
      width: 90%;
      max-width: 400px;
      position: relative;
    }
    #settings-modal h2 {
      margin-bottom: 20px;
      color: var(--primary-color);
    }
    .close-button {
      position: absolute;
      right: 15px;
      top: 15px;
      font-size: 1.5rem;
      cursor: pointer;
    }
    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .setting-item span.label {
      font-size: 1rem;
      color: var(--text-color);
    }
    /* Generic switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 34px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 34px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 26px;
      width: 26px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--primary-color);
    }
    input:checked + .slider:before {
      transform: translateX(26px);
    }
    /* Switch for dark mode with icons (corrected for better alignment) */
    .dark-slider:before {
    content: "\f185"; /* sun */
    font-family: "Font Awesome 6 Free";
    font-weight: 900;
    position: absolute;
    top: 3px;
    left: 6px;
    font-size: 18px;
    color: #f39c12;
    }

    input:checked + .dark-slider:before {
    content: "\f186"; /* moon */
    left: auto;
    right: 30px;
    top: 3px;
    color: #f1c40f;
    }
    
    /* Class to highlight searched text; uses the color defined by --highlight-bg, which changes dynamically based on the theme (light/dark mode). */
    .highlight {
      background-color: var(--highlight-bg);
      font-weight: bold;
    }

    /* Styling for code blocks */
    .code-block {
        background-color: #dcdcdc; /* Gainsboro */
        padding: 1em;
        border-radius: 5px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
    }

    /* Styles for code block container and copy button */
    .code-block-container {
        position: relative;
        margin: 1em 0;
    }

    .copy-code-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background-color: #7e7c7c;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        display: none; /* Hidden by default */
        opacity: 0.7;
    }

    .code-block-container:hover .copy-code-btn {
        display: block; /* Show on hover */
    }
    
    .copy-code-btn:hover {
        opacity: 1;
    }

    body.dark-mode .copy-code-btn {
        background-color: #444;
        color: #f0f0f0;
    }


    /* Markdown content styles */
    .message-content h1,
    .message-content h2,
    .message-content h3,
    .message-content h4,
    .message-content h5,
    .message-content h6 {
      margin: 16px 0 8px 0;
      font-weight: 600;
      color: var(--text-color);
    }

    .message-content h1 { font-size: 1.8rem; }
    .message-content h2 { font-size: 1.5rem; }
    .message-content h3 { font-size: 1.3rem; }
    .message-content h4 { font-size: 1.1rem; }
    .message-content h5 { font-size: 1rem; }
    .message-content h6 { font-size: 0.9rem; }

    .message-content ul,
    .message-content ol {
      margin: 8px 0;
      padding-left: 20px;
    }

    .message-content li {
      margin: 4px 0;
    }

    .message-content blockquote {
      border-left: 4px solid var(--primary-color);
      margin: 16px 0;
      padding: 8px 16px;
      background-color: var(--hover-color);
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .message-content table {
      border-collapse: collapse;
      margin: 16px 0;
      width: 100%;
    }

    .message-content th,
    .message-content td {
      border: 1px solid var(--border-color);
      padding: 8px 12px;
      text-align: left;
    }

    .message-content th {
      background-color: var(--hover-color);
      font-weight: 600;
    }

    .message-content code:not(.code-block code) {
      background-color: var(--hover-color);
      padding: 2px 4px;
      border-radius: 3px;
      font-size: 0.9em;
      font-family: 'Courier New', monospace;
    }

    body.dark-mode .message-content code:not(.code-block code) {
      background-color: #2b2b2b;
    }

    /* Markdown toggle switch styles */
    .markdown-toggle-container {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .markdown-toggle-label {
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
    }

    .markdown-toggle-text {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-color);
    }

    .markdown-toggle-switch {
      position: relative;
    }

    .markdown-toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .markdown-slider {
      position: relative;
      display: inline-block;
      width: 60px;
      height: 30px;
      background-color: #ccc;
      border-radius: 30px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .markdown-slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 3px;
      top: 3px;
      background-color: white;
      border-radius: 50%;
      transition: all 0.3s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .markdown-toggle-switch input:checked + .markdown-slider {
      background-color: var(--primary-color);
    }

    .markdown-toggle-switch input:checked + .markdown-slider:before {
      transform: translateX(30px);
    }

    .markdown-icon-off,
    .markdown-icon-on {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      transition: all 0.3s ease;
    }

    .markdown-icon-off {
      left: 8px;
      color: #666;
    }

    .markdown-icon-on {
      right: 8px;
      color: white;
      opacity: 0;
    }

    .markdown-toggle-switch input:checked + .markdown-slider .markdown-icon-off {
      opacity: 0;
    }

    .markdown-toggle-switch input:checked + .markdown-slider .markdown-icon-on {
      opacity: 1;
    }

    /* Dark mode adjustments */
    body.dark-mode .markdown-toggle-text {
      color: var(--text-color);
    }

    body.dark-mode .markdown-slider {
      background-color: #555;
    }

    body.dark-mode .markdown-icon-off {
      color: #aaa;
    }
</style>
</head>
<body>
  <!-- Progress bar -->
  <div id="loading-overlay">
    <div id="loading-bar"></div>
  </div>

  <!-- Upload wrapper to center the upload area -->
  <div id="upload-wrapper">
    <div id="upload-area">
      <h1 class="upload-title"><i class="fas fa-comments"></i> <span>LLM Chat Explorer</span></h1>
      <p class="small-text">
        Upload the export of your chat data from ChatGPT or Claude to view and analyze conversations in an intuitive and user-friendly interface.
      </p>
      </br>
      <p class="upload-instruction">Drag and drop the JSON file or click to select it</p>
      <input type="file" id="json-file" accept=".json" style="display: none;">
    </div>
  </div>

  <!-- Main app (hidden until JSON is loaded) -->
  <div class="app-container" style="display: none;">
    <div class="sidebar">
      <div class="sidebar-header">
        <h1 style="cursor: pointer;" onclick="location.reload();" title="Click here to reload the page"><i class="fas fa-comments"></i> LLM Chat Explorer</h1>
      </div>
      <div id="chat-counter">
        <div class="chat-info">
          <i class="fas fa-chart-bar"></i>
          <span id="chat-counter-text">0 chats total</span>
        </div>
        <div id="service-label" style="margin-left: 10px; font-size: 0.9rem; color: var(--text-light);">
          Source:
        </div>
        <div id="open-settings" title="Open settings">
          <i class="fas fa-gear"></i>
        </div>
      </div>
      <div class="search-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="search-bar" placeholder="Search conversations...">
        <span id="clear-search" class="clear-search">&times;</span>
      </div>
      <div class="search-options">
        <input type="checkbox" id="search-content-toggle">
        <label for="search-content-toggle">Search within message content</label>
      </div>
      <ul id="chat-list" class="chat-list">
        <!-- Chat titles will be inserted here -->
      </ul>
    </div>
    <div class="content">
      <div class="content-header">
      <div style="display:inline-flex; align-items:center; gap:6px;">
        <h2 id="chat-title" style="margin:0;">Select a chat</h2>
        <button id="share-button" title="Share chat" style="background:none; border:none; cursor:pointer;">
          <i class="fas fa-share"></i>
        </button>
      </div>
      <div style="display: flex; align-items: center; gap: 10px;">
        <div class="markdown-toggle-container">
          <label class="markdown-toggle-label">
            <span class="markdown-toggle-text">Markdown</span>
            <div class="markdown-toggle-switch">
              <input type="checkbox" id="markdown-toggle" checked>
              <span class="markdown-slider">
                <i class="fas fa-code markdown-icon-off"></i>
                <i class="fas fa-eye markdown-icon-on"></i>
              </span>
            </div>
          </label>
        </div>
        <a id="chat-link" href="#" target="_blank" class="external-link" style="display: none;">
          <i class="fas fa-external-link-alt"></i> View on 
        </a>
      </div>
      </div>
      <div id="chat-content" class="chat-messages">
      <div class="empty-state">
        <i class="fas fa-hand-point-left"></i>
        <p>Select a conversation from the list to view it</p>
      </div>
      </div>
    </div>
    </div>

    <!-- Settings modal -->
    <div id="settings-modal">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Settings</h2>
      <div class="setting-item">
      <span class="label" id="dark-mode-label">Dark mode:</span>
      <label class="switch">
        <input type="checkbox" id="modal-dark-toggle">
        <span class="slider dark-slider"></span>
      </label>
      </div>
      <div class="setting-item">
      <span class="label" id="chat-position-label">Chat position:</span>
      <label class="switch">
        <input type="checkbox" id="modal-chat-toggle" checked>
        <span class="slider"></span>
      </label>
      <span id="chat-position-text">At end</span>
      </div>
      <div class="setting-item">
      <span class="label" id="language-label">Language:</span>
      <select id="language-select">
        <option value="en">English</option>
        <option value="it">Italiano</option>
        <option value="es">Español</option>
        <option value="fr">Français</option>
        <option value="de">Deutsch</option>
        <option value="pl">Polski</option>
        <option value="zh">中文</option>
        <option value="ko">한국어</option>
        <option value="ja">日本語</option>      
      </select>
      </div>
    </div>
    </div>

  <script>
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    function copyCode(button) {
        const pre = button.nextElementSibling;
        const code = pre.innerText;
        navigator.clipboard.writeText(code).then(() => {
            button.textContent = 'Copied!';
            const originalText = 'Copy';
            setTimeout(() => {
                button.textContent = originalText;
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy code: ', err);
            button.textContent = 'Error';
        });
    }

    /* Translations for various languages */
    const translations = {
      it: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "Clicca qui per ricaricare la pagina",
        uploadInstruction: "Trascina qui il file JSON (conversations.json) oppure clicca per selezionarlo",
        metaDescription: "LLM Chat Explorer è un'applicazione web che consente di visualizzare e analizzare le esportazioni delle conversazioni da ChatGPT e Claude, offrendo un'interfaccia intuitiva per gestire la cronologia chat.",
        uploadDescription: "Carica l'esportazione dei tuoi dati di chat da ChatGPT o Claude per visualizzare e analizzare le conversazioni in un'interfaccia intuitiva e user-friendly.",
        sourceLabel: "Fonte:",
        openSettingsTooltip: "Apri impostazioni",
        searchPlaceholder: "Cerca conversazioni...",
        selectChat: "Seleziona una chat",
        emptyState: "Seleziona una conversazione dalla lista per visualizzarla",
        noMessage: "Nessun messaggio disponibile per questa chat",
        viewOnChatGPT: "Visualizza su ChatGPT",
        viewOnClaude: "Visualizza su Claude",
        settingsTitle: "Impostazioni",
        darkModeLabel: "Modalità dark:",
        chatPositionLabel: "Posizione chat:",
        languageLabel: "Lingua:",
        chatPositionEnd: "Alla fine",
        chatPositionStart: "All'inizio",
        chatCountSuffix: "chat totali",
        searchContentLabel: "Ricerca nel contenuto dei messaggi",
        shareButtonTitle: "Condividi chat",
        copyNotification: "Link della chat copiato negli appunti!",
        jsonParseError: "Errore nel parsing del file JSON: ",
        fileReadError: "Errore nella lettura del file",
        copyError: "Errore nel copiare le informazioni",
        userSender: "Tu",
        visibleSeparator: "di"
      },
      en: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "Click here to reload the page",
        uploadInstruction: "Drag and drop the JSON file (conversations.json) or click to select it",
        metaDescription: "LLM Chat Explorer is a web application that allows you to view and analyze conversation exports from ChatGPT and Claude, offering an intuitive interface to manage chat history.",
        uploadDescription: "Upload the export of your chat data from ChatGPT or Claude to view and analyze conversations in an intuitive and user-friendly interface.",
        sourceLabel: "Source:",
        openSettingsTooltip: "Open settings",
        searchPlaceholder: "Search conversations...",
        selectChat: "Select a chat",
        emptyState: "Select a conversation from the list to view it",
        noMessage: "No messages available for this chat",
        viewOnChatGPT: "View on ChatGPT",
        viewOnClaude: "View su Claude",
        settingsTitle: "Settings",
        darkModeLabel: "Dark mode:",
        chatPositionLabel: "Chat position:",
        languageLabel: "Language:",
        chatPositionEnd: "At end",
        chatPositionStart: "At start",
        chatCountSuffix: "chats total",
        searchContentLabel: "Search within message content",
        shareButtonTitle: "Share chat",
        copyNotification: "Chat link copied to clipboard!",
        jsonParseError: "JSON file parsing error: ",
        fileReadError: "File reading error",
        copyError: "Error copying information",
        userSender: "You",
        visibleSeparator: "of"
      },
      es: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "Haz clic aquí para recargar la página",
        uploadInstruction: "Arrastra el archivo JSON (conversations.json) o haz clic para seleccionarlo",
        metaDescription: "LLM Chat Explorer es una aplicación web que te permite visualizar y analizar las exportaciones de conversaciones de ChatGPT y Claude, ofreciendo una interfaz intuitiva para gestionar el historial de chats.",
        uploadDescription: "Carga la exportación de tus datos de chat de ChatGPT o Claude para visualizar y analizar las conversaciones en una interfaz intuitiva y fácil de usar.",
        sourceLabel: "Fuente:",
        openSettingsTooltip: "Abrir ajustes",
        searchPlaceholder: "Buscar conversaciones...",
        selectChat: "Selecciona un chat",
        emptyState: "Selecciona una conversación de la lista para visualizarla",
        noMessage: "No hay mensajes disponibles para este chat",
        viewOnChatGPT: "Ver en ChatGPT",
        viewOnClaude: "Ver en Claude",
        settingsTitle: "Configuraciones",
        darkModeLabel: "Modo oscuro:",
        chatPositionLabel: "Posición del chat:",
        languageLabel: "Idioma:",
        chatPositionEnd: "Al final",
        chatPositionStart: "Al principio",
        chatCountSuffix: "chats totales",
        searchContentLabel: "Buscar en el contenido de los mensajes",
        shareButtonTitle: "Compartir chat",
        copyNotification: "¡Enlace del chat copiado al portapapeles!",
        jsonParseError: "Error al analizar el archivo JSON: ",
        fileReadError: "Error al leer el archivo",
        copyError: "Error al copiar la información",
        userSender: "Tú",
        visibleSeparator: "de"
      },
      fr: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "Cliquez ici pour recharger la page",
        uploadInstruction: "Faites glisser le fichier JSON (conversations.json) ou cliquez pour le sélectionner",
        metaDescription: "LLM Chat Explorer est une application web qui vous permet de visualiser et d'analyser les exportations de conversations de ChatGPT et Claude, offrant une interface intuitive pour gérer l'historique des chats.",
        uploadDescription: "Téléchargez l'exportation de vos données de chat de ChatGPT ou Claude pour visualiser et analyser les conversations dans une interface intuitive et conviviale.",
        sourceLabel: "Source:",
        openSettingsTooltip: "Ouvrir les paramètres",
        searchPlaceholder: "Rechercher des conversations...",
        selectChat: "Sélectionnez une conversation",
        emptyState: "Sélectionnez une conversation dans la liste pour l'afficher",
        noMessage: "Aucun message disponible pour cette conversation",
        viewOnChatGPT: "Voir sur ChatGPT",
        viewOnClaude: "Voir sur Claude",
        settingsTitle: "Paramètres",
        darkModeLabel: "Mode sombre:",
        chatPositionLabel: "Position du chat:",
        languageLabel: "Langue:",
        chatPositionEnd: "À la fin",
        chatPositionStart: "Au début",
        chatCountSuffix: "chats totaux",
        searchContentLabel: "Rechercher dans le contenu des messages",
        shareButtonTitle: "Partager le chat",
        copyNotification: "Lien du chat copié dans le presse-papiers !",
        jsonParseError: "Erreur lors de l'analyse du fichier JSON : ",
        fileReadError: "Erreur lors de la lecture du fichier",
        copyError: "Erreur lors de la copie des informations",
        userSender: "Vous",
        visibleSeparator: "de"
      },
      de: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "Klicken Sie hier, um die Seite neu zu laden",
        uploadInstruction: "Ziehen Sie die JSON-Datei (conversations.json) per Drag & Drop oder klicken Sie, um sie auszuwählen",
        metaDescription: "LLM Chat Explorer ist eine Webanwendung, die es Ihnen ermöglicht, Gesprächsexporte von ChatGPT und Claude anzusehen und zu analysieren, und bietet eine intuitive Benutzeroberfläche zur Verwaltung des Chatverlaufs.",
        uploadDescription: "Laden Sie den Export Ihrer Chat-Daten von ChatGPT oder Claude hoch, um die Gespräche in einer intuitiven und benutzerfreundlichen Oberfläche anzuzeigen und zu analysieren.",
        sourceLabel: "Quelle:",
        openSettingsTooltip: "Einstellungen öffnen",
        searchPlaceholder: "Suche Unterhaltungen...",
        selectChat: "Wähle einen Chat",
        emptyState: "Wählen Sie einen Chat aus der Liste, um ihn anzuzeigen",
        noMessage: "Keine Nachrichten für diesen Chat verfügbar",
        viewOnChatGPT: "Auf ChatGPT anzeigen",
        viewOnClaude: "Auf Claude anzeigen",
        settingsTitle: "Einstellungen",
        darkModeLabel: "Dunkelmodus:",
        chatPositionLabel: "Chatposition:",
        languageLabel: "Sprache:",
        chatPositionEnd: "Am Ende",
        chatPositionStart: "Am Anfang",
        chatCountSuffix: "Chats insgesamt",
        searchContentLabel: "Im Nachrichteninhalt suchen",
        shareButtonTitle: "Chat teilen",
        copyNotification: "Chat-Link in die Zwischenablage kopiert!",
        jsonParseError: "Fehler beim Parsen der JSON-Datei: ",
        fileReadError: "Fehler beim Lesen der Datei",
        copyError: "Fehler beim Kopieren der Informationen",
        userSender: "Du",
        visibleSeparator: "von"
      },
      pl: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "Kliknij tutaj, aby przeładować stronę",
        uploadInstruction: "Przeciągnij plik JSON (conversations.json) tutaj lub kliknij, aby go wybrać",
        metaDescription: "LLM Chat Explorer to aplikacja internetowa, która umożliwia przeglądanie i analizowanie eksportów konwersacji z ChatGPT i Claude, oferując intuicyjny interfejs do zarządzania historią czatu.",
        uploadDescription: "Prześlij eksport swoich danych czatu z ChatGPT lub Claude, aby przeglądać i analizować konwersacje w intuicyjnym i przyjaznym dla użytkownika interfejsie.",
        sourceLabel: "Źródło:",
        openSettingsTooltip: "Otwórz ustawienia",
        searchPlaceholder: "Szukaj konwersacji...",
        selectChat: "Wybierz czat",
        emptyState: "Wybierz konwersację z listy, aby ją wyświetlić",
        noMessage: "Brak wiadomości dostępnych dla tego czatu",
        viewOnChatGPT: "Wyświetl na ChatGPT",
        viewOnClaude: "Wyświetl na Claude",
        settingsTitle: "Ustawienia",
        darkModeLabel: "Tryb ciemny:",
        chatPositionLabel: "Pozycja czatu:",
        languageLabel: "Język:",
        chatPositionEnd: "Na końcu",
        chatPositionStart: "Na początku",
        chatCountSuffix: "czatów łącznie",
        searchContentLabel: "Szukaj w treści wiadomości",
        shareButtonTitle: "Udostępnij czat",
        copyNotification: "Link do czatu skopiowany do schowka!",
        jsonParseError: "Błąd podczas analizowania pliku JSON: ",
        fileReadError: "Błąd podczas odczytu pliku",
        copyError: "Błąd podczas kopiowania informacji",
        userSender: "Ty",
        visibleSeparator: "z"
      },
      zh: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "点击此处重新加载页面",
        uploadInstruction: "将 JSON 文件 (conversations.json) 拖放到此处或单击以选择",
        metaDescription: "LLM Chat Explorer 是一个网页应用程序，可让您查看和分析来自 ChatGPT 和 Claude 的对话导出，并提供直观的界面来管理聊天历史。",
        uploadDescription: "上传您的 ChatGPT 或 Claude 聊天数据导出文件，以直观、用户友好的界面查看和分析对话。",
        sourceLabel: "来源:",
        openSettingsTooltip: "打开设置",
        searchPlaceholder: "搜索对话...",
        selectChat: "选择一个聊天",
        emptyState: "从列表中选择对话以查看",
        noMessage: "该聊天没有可用消息",
        viewOnChatGPT: "在 ChatGPT 上查看",
        viewOnClaude: "在 Claude 上查看",
        settingsTitle: "设置",
        darkModeLabel: "暗黑模式:",
        chatPositionLabel: "聊天位置:",
        languageLabel: "语言:",
        chatPositionEnd: "在末尾",
        chatPositionStart: "在开头",
        chatCountSuffix: "总聊天数",
        searchContentLabel: "搜索消息内容",
        shareButtonTitle: "分享聊天",
        copyNotification: "聊天链接已复制到剪贴板！",
        jsonParseError: "JSON 文件解析错误: ",
        fileReadError: "文件读取错误",
        copyError: "复制信息时出错",
        userSender: "你",
        visibleSeparator: "的"
      },
      ko: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "페이지를 새로고침하려면 여기를 클릭하세요",
        uploadInstruction: "JSON 파일 (conversations.json)을 여기에 드래그 앤 드롭하거나 클릭하여 선택하세요",
        metaDescription: "LLM Chat Explorer는 ChatGPT와 Claude의 대화 내보내기를 확인하고 분석할 수 있는 웹 애플리케이션으로, 채팅 기록을 관리하기 위한 직관적인 인터페이스를 제공합니다.",
        uploadDescription: "ChatGPT 또는 Claude의 채팅 데이터 내보내기를 업로드하여 직관적이고 사용자 친화적인 인터페이스에서 대화를 확인하고 분석하세요.",
        sourceLabel: "출처:",
        openSettingsTooltip: "설정 열기",
        searchPlaceholder: "대화를 검색하세요...",
        selectChat: "채팅 선택",
        emptyState: "목록에서 대화를 선택하여 표시하세요",
        noMessage: "이 채팅에 사용 가능한 메시지가 없습니다",
        viewOnChatGPT: "ChatGPT에서 보기",
        viewOnClaude: "Claude에서 보기",
        settingsTitle: "설정",
        darkModeLabel: "다크 모드:",
        chatPositionLabel: "채팅 위치:",
        languageLabel: "언어:",
        chatPositionEnd: "끝에",
        chatPositionStart: "처음에",
        chatCountSuffix: "총 채팅 수",
        searchContentLabel: "메시지 내용 검색",
        shareButtonTitle: "채팅 공유",
        copyNotification: "채팅 링크가 클립보드에 복사되었습니다!",
        jsonParseError: "JSON 파일 구문 분석 오류: ",
        fileReadError: "파일 읽기 오류",
        copyError: "정보 복사 오류",
        userSender: "너",
        visibleSeparator: "의"
      },
      ja: {
        uploadTitle: "LLM Chat Explorer",
        reloadTooltip: "ページを再読み込みするにはここをクリックしてください",
        uploadInstruction: "JSONファイル (conversations.json) をここにドラッグ＆ドロップするか、クリックして選択してください",
        metaDescription: "LLM Chat Explorer は、ChatGPT と Claude からの会話のエクスポートを表示および解析できるウェブアプリケーションで、チャット履歴を管理するための直感的なインターフェースを提供します。",
        uploadDescription: "ChatGPT または Claude のチャットデータのエクスポートをアップロードして、直感的で使いやすいインターフェースで会話を表示および解析してください。",
        sourceLabel: "出典:",
        openSettingsTooltip: "設定を開く",
        searchPlaceholder: "会話を検索...",
        selectChat: "チャットを選択",
        emptyState: "リストから会話を選択して表示",
        noMessage: "このチャットには利用可能なメッセージがありません",
        viewOnChatGPT: "ChatGPTで表示",
        viewOnClaude: "Claudeで表示",
        settingsTitle: "設定",
        darkModeLabel: "ダークモード:",
        chatPositionLabel: "チャット位置:",
        languageLabel: "言語:",
        chatPositionEnd: "最後に",
        chatPositionStart: "最初に",
        chatCountSuffix: "合計チャット数",
        searchContentLabel: "メッセージ内容を検索",
        shareButtonTitle: "チャットを共有",
        copyNotification: "チャットリンクがクリップボードにコピーされました！",
        jsonParseError: "JSONファイルの解析エラー: ",
        fileReadError: "ファイル読み取りエラー",
        copyError: "情報のコピーエラー",
        userSender: "あなた",
        visibleSeparator: "の"
      }
    };
    // Global function to render messages
    function renderMessages(messages) {
      const lang = localStorage.getItem('language') || 'en';
      let html = '';
      messages.forEach((msgObj) => {
        const role = msgObj.role || "assistant"; // fallback
        if (role === "user") {
        html += `
          <div class="message message-user">
          <div class="message-header">
            <div class="avatar" title="User">U</div>
            <span class="sender">${translations[lang].userSender}</span>
          </div>
          <div class="message-content">${formatMessage(msgObj.text)}</div>
          </div>`;
        } else {
        html += `
          <div class="message message-assistant">
          <div class="message-header">
            <div class="avatar" title="Assistant" style="background-color: var(--primary-color)">A</div>
            <span class="sender">${window.currentService}</span>
          </div>
          <div class="message-content">${formatMessage(msgObj.text)}</div>
          </div>`;
        }
      });
      document.getElementById("chat-content").innerHTML = html;
      const scrollPreference = localStorage.getItem('chatPosition') || 'end';
      const chatContent = document.getElementById("chat-content");
      chatContent.scrollTop = scrollPreference === 'end' ? chatContent.scrollHeight : 0;
    }
    
    // Global function to format message text
    function formatMessage(text) {
      if (!text) return '';
      
      // Check if markdown rendering is enabled
      const isMarkdownEnabled = window.markdownEnabled || false;
      
      if (isMarkdownEnabled) {
        
        if (typeof marked !== 'undefined') {
          // Configure marked.js options
          marked.setOptions({
            breaks: true,
            gfm: true,
            tables: true,
            sanitize: false
          });
          
          // Use marked.js to render markdown - try both API formats
          let htmlContent;
          try {
            htmlContent = marked.parse ? marked.parse(text) : marked(text);
          } catch (e) {
            console.error('Error parsing markdown:', e);
            htmlContent = marked(text); // fallback to older API
          }
          
          // Apply syntax highlighting for code blocks
          htmlContent = htmlContent.replace(/<pre><code class="language-(\w+)">([\s\S]*?)<\/code><\/pre>/g, (match, lang, code) => {
            const decodedCode = code.replace(/&lt;/g, '<').replace(/&gt;/g, '>').replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
            const copyButton = `<button class="copy-code-btn" onclick="copyCode(this)">Copy</button>`;
            return `<div class="code-block-container">${copyButton}<pre class="code-block">${code}</pre></div>`;
          });
          
          // Handle regular code blocks without language specification
          htmlContent = htmlContent.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g, (match, code) => {
            const copyButton = `<button class="copy-code-btn" onclick="copyCode(this)">Copy</button>`;
            return `<div class="code-block-container">${copyButton}<pre class="code-block">${code}</pre></div>`;
          });
          
          text = htmlContent;
        } else {
          console.error('marked.js is not loaded!');
          // Fallback to original rendering if marked.js is not available
          text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
          text = text.replace(/```(\w*)\n?([\s\S]+?)```/g, (match, lang, code) => {
            const trimmedCode = code.trim();
            const codeElement = `<pre class="code-block">${escapeHtml(trimmedCode)}</pre>`;
            
            let copyButton = '';
            if (!trimmedCode.startsWith("Viewing artifacts")) {
                copyButton = `<button class="copy-code-btn" onclick="copyCode(this)">Copy</button>`;
            }
            
            return `<div class="code-block-container">${copyButton}${codeElement}</div>`;
          });
          text = text.replace(/(?<!<\/pre>)\n/g, '<br>');
        }
      } else {
        // Original formatting (non-markdown mode)
        text = text.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank" style="color: var(--primary-color);">$1</a>');
        text = text.replace(/```(\w*)\n?([\s\S]+?)```/g, (match, lang, code) => {
          const trimmedCode = code.trim();
          const codeElement = `<pre class="code-block">${escapeHtml(trimmedCode)}</pre>`;
          
          let copyButton = '';
          if (!trimmedCode.startsWith("Viewing artifacts")) {
              copyButton = `<button class="copy-code-btn" onclick="copyCode(this)">Copy</button>`;
          }
          
          return `<div class="code-block-container">${copyButton}${codeElement}</div>`;
        });
        text = text.replace(/(?<!<\/pre>)\n/g, '<br>');
      }
      
      // Highlight searched words in the content if the checkbox is active
      const searchTerm = document.getElementById("search-bar").value.toLowerCase().trim();
      const searchInContent = document.getElementById("search-content-toggle") && document.getElementById("search-content-toggle").checked;
      if (searchTerm && searchInContent) {
        const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
        words.forEach(word => {
        const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'gi');
        text = text.replace(regex, `<span class="highlight">$1</span>`);
        });
      }
      return text;
    }

    // Update texts based on the selected language
    function updateTranslations() {
      const lang = localStorage.getItem('language') || 'en';
      // Update the meta tag description
      document.querySelector("meta[name='description']").setAttribute("content", translations[lang].metaDescription);
      // Update the tooltip of the clickable title in the sidebar-header
      document.querySelector(".sidebar-header h1").setAttribute("title", translations[lang].reloadTooltip);
      // Update the tooltip of the settings icon
      document.getElementById("open-settings").setAttribute("title", translations[lang].openSettingsTooltip);
      // Upload area
      document.querySelector("#upload-area .upload-title span").textContent = translations[lang].uploadTitle;
      document.querySelector("#upload-area p.small-text").textContent = translations[lang].uploadDescription;
      document.querySelector("#upload-area p.upload-instruction").textContent = translations[lang].uploadInstruction;
      // Search placeholder
      document.getElementById("search-bar").placeholder = translations[lang].searchPlaceholder;
      // Content header: if nothing has been selected yet, show the default text
      if(document.getElementById("chat-title").textContent.trim() === "Select a chat" ||
       document.getElementById("chat-title").textContent.trim() === "Seleziona una chat" ||
       document.getElementById("chat-title").textContent.trim() === "Selecciona un chat" ||
       document.getElementById("chat-title").textContent.trim() === "Sélectionnez une conversation" ||
       document.getElementById("chat-title").textContent.trim() === "Wähle einen Chat" ||
       document.getElementById("chat-title").textContent.trim() === "Wybierz czat" ||
       document.getElementById("chat-title").textContent.trim() === "选择一个聊天" ||
       document.getElementById("chat-title").textContent.trim() === "채팅 선택" ||
       document.getElementById("chat-title").textContent.trim() === "チャットを選択") {
      document.getElementById("chat-title").textContent = translations[lang].selectChat;
      }
      // External link text
      document.querySelector("#chat-link").innerHTML = '<i class="fas fa-external-link-alt"></i> ' + translations[lang].viewOnChatGPT;
      // Empty state
      let emptyStateP = document.querySelector(".empty-state p");
      if(emptyStateP) {
      emptyStateP.textContent = translations[lang].emptyState;
      }
      // Update the service label if it exists and the service has already been determined
      if (document.getElementById("service-label") && window.currentService) {
      document.getElementById("service-label").textContent = translations[lang].sourceLabel + " " + window.currentService;
      }
      // Settings modal
      document.querySelector("#settings-modal h2").textContent = translations[lang].settingsTitle;
      document.getElementById("dark-mode-label").textContent = translations[lang].darkModeLabel;
      document.getElementById("chat-position-label").textContent = translations[lang].chatPositionLabel;
      document.getElementById("language-label").textContent = translations[lang].languageLabel;
      // Update the chat position text in the modal based on the toggle state
      const chatPosToggle = document.getElementById("modal-chat-toggle");
      if(chatPosToggle.checked) {
      document.getElementById("chat-position-text").textContent = translations[lang].chatPositionEnd;
      } else {
      document.getElementById("chat-position-text").textContent = translations[lang].chatPositionStart;
      }
      document.querySelector(".search-options label[for='search-content-toggle']").textContent = translations[lang].searchContentLabel;
      document.getElementById("share-button").title = translations[lang].shareButtonTitle;

      // Update the counter based on the search field content
      const searchBar = document.getElementById("search-bar");
      const currentSearch = searchBar.value.toLowerCase().trim();
      if (currentSearch !== "") {
      // If there is an active filter, count the visible chats
      let visibleCount = 0;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        if (li.style.display !== "none") {
        visibleCount++;
        }
      });
      document.getElementById("chat-counter-text").textContent =
        visibleCount + " " + translations[lang].visibleSeparator + " " + window.totalChats + " " + translations[lang].chatCountSuffix;
      } else {
      document.getElementById("chat-counter-text").textContent = window.totalChats + " " + translations[lang].chatCountSuffix;
      }
    }

    // Function to format the date in dd/mm/yyyy format
    function formatDate(date) {
      const d = new Date(date);
      const day = ('0' + d.getDate()).slice(-2);
      const month = ('0' + (d.getMonth() + 1)).slice(-2);
      const year = d.getFullYear();
      return `${day}/${month}/${year}`;
    }

    function processData(data) {
      const lang = localStorage.getItem('language') || 'en';
      let conversations = [];
      if (Array.isArray(data)) {
      conversations = data;
      } else {
      conversations = data.conversations || [];
      }

      // If the file is in Claude format (i.e., if the first object contains the property chat_messages), the order is from oldest to newest.
      // Reverse the array to have the same order (from most recent to oldest) as ChatGPT to normalize the chat flow display.
      if (conversations.length > 0 && conversations[0].chat_messages) {
      conversations.reverse();
      }

      // Save the total globally
      window.totalChats = conversations.length;

      let chatListHTML = '';
      const chatData = {};

      conversations.forEach((chat, index) => {
      // Use 'title' (ChatGPT) or 'name' (Claude) for the title
      let title = chat.title || chat.name || `Chat ${index + 1}`;
      let messages = [];
      let service = "ChatGPT"; // default
      let uuid = null;
      let conversation_id = null;

      // If the format is Claude (field "chat_messages")
      if (chat.chat_messages) {
        service = "Claude";
        uuid = chat.uuid; // from Claude
        chat.chat_messages.forEach((msg) => {
        // Map the role based on the sender field
        let role = "";
        if (msg.sender) {
          role = msg.sender === "human" ? "user" : "assistant";
        } else {
          role = "assistant"; // default
        }
        if (msg.text && msg.text.trim() !== '') {
          messages.push({ text: msg.text, role: role });
        } else if (msg.content) {
          msg.content.forEach((part) => {
          if (part.text && part.text.trim() !== '') {
            messages.push({ text: part.text, role: role });
          }
          });
        }
        });
      }
      // If the format is ChatGPT with mapping
      else if (chat.mapping) {
        if (chat.conversation_id) {
        conversation_id = chat.conversation_id;
        }
        for (let key in chat.mapping) {
        const messageObj = chat.mapping[key];
        if (messageObj.message && messageObj.message.content) {
          // Extract the role from the author.role field (default to "assistant" if not present)
          const role = messageObj.message.author && messageObj.message.author.role ? messageObj.message.author.role : "assistant";
          const parts = messageObj.message.content.parts || [];
          parts.forEach((part) => {
          if (typeof part === 'string' && part.trim() !== '') {
            messages.push({ text: part, role: role });
          }
          });
        }
        }
      }

      // Handle creation date (Claude uses "created_at")
      let createdTime = null;
      if (chat.created_at) {
        createdTime = new Date(chat.created_at);
      } else if (chat.create_time) {
        createdTime = typeof chat.create_time === 'number' ? new Date(chat.create_time * 1000) : new Date(chat.create_time);
      }

      let displayTitle = title;
      if (createdTime) {
        displayTitle += ` <span class='chat-date'>${formatDate(createdTime)}</span>`;
      }
      chatListHTML += `<li data-id="${index}" title="${title}">${displayTitle}</li>`;
      chatData[index] = {
        title: title,
        messages: messages,
        created_time: createdTime ? formatDate(createdTime) : "",
        service: service,
        uuid: uuid,
        conversation_id: conversation_id
      };
      });

      document.getElementById("chat-list").innerHTML = chatListHTML;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
      li.setAttribute("data-original", li.innerHTML);
      });
      if (conversations.length > 0) {
      // If the first object contains "chat_messages", the file is from Claude, otherwise ChatGPT
      let serviceType = (conversations[0].chat_messages) ? "Claude" : "ChatGPT";
      window.currentService = serviceType; // Save the service globally
      document.getElementById("service-label").textContent = translations[lang].sourceLabel + " " + serviceType;
      }
      const searchBar = document.getElementById("search-bar");
      const clearSearch = document.getElementById("clear-search");

      searchBar.addEventListener("input", () => {
      const searchTerm = searchBar.value.toLowerCase().trim();
      clearSearch.style.display = searchTerm !== "" ? "block" : "none";
      const words = searchTerm.split(/\s+/).filter(word => word.length > 0);
      const searchInContent = document.getElementById("search-content-toggle").checked;
      let visibleCount = 0; // variable to count visible chats

      Array.from(document.getElementById("chat-list").children).forEach(li => {
        const chatId = li.getAttribute("data-id");
        const chat = chatData[chatId];
        const titleText = chat.title.toLowerCase();
        // Check the title
        const titleMatches = words.every(word => titleText.includes(word));
        let contentMatches = false;
        if (searchInContent && chat.messages) {
        contentMatches = chat.messages.some(msgObj => {
          return words.every(word => msgObj.text.toLowerCase().includes(word));
        });
        }
        const matches = titleMatches || contentMatches;
        li.style.display = matches ? "" : "none";
        if (matches) {
        visibleCount++;
        // Highlight in the title (if applicable)
        if (titleMatches && words.length > 0) {
          let newHTML = li.getAttribute("data-original");
          words.forEach(word => {
          const regex = new RegExp(`(${word.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\$&')})`, 'gi');
          newHTML = newHTML.replace(regex, `<span class="highlight">$1</span>`);
          });
          li.innerHTML = newHTML;
        } else {
          li.innerHTML = li.getAttribute("data-original");
        }
        }
      });
      
      // Update the counter: "visible of total chats total"
      const lang = localStorage.getItem('language') || 'en';
      if (visibleCount === window.totalChats) {
        document.getElementById("chat-counter-text").textContent = window.totalChats + " " + translations[lang].chatCountSuffix;
      } else {
        document.getElementById("chat-counter-text").textContent = visibleCount + " " + translations[lang].visibleSeparator + " " + window.totalChats + " " + translations[lang].chatCountSuffix;
      }
      
      // If a chat is active, also update the message content
      const activeLi = document.querySelector(".chat-list li.active");
      if (activeLi) {
        const activeChatId = activeLi.getAttribute("data-id");
        renderMessages(chatData[activeChatId].messages);
      }
      });
      // Add this listener to update the search when the checkbox changes:
      document.getElementById("search-content-toggle").addEventListener("change", () => {
      // Simulate the "input" event on the search field to update the results
      searchBar.dispatchEvent(new Event("input"));
      });
      clearSearch.addEventListener("click", () => {
      searchBar.value = "";
      clearSearch.style.display = "none";
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.style.display = "";
        li.innerHTML = li.getAttribute("data-original");
      });
      searchBar.focus();
      // Update the counter to show the total, as the filter has been removed
      const lang = localStorage.getItem('language') || 'en';
      document.getElementById("chat-counter-text").textContent = window.totalChats + " " + translations[lang].chatCountSuffix;
      });
      document.getElementById("chat-list").addEventListener("click", (event) => {
      const clickedLi = event.target.closest("li");
      if (!clickedLi) return;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.classList.remove("active");
      });
      clickedLi.classList.add("active");
      const chatId = clickedLi.getAttribute("data-id");
      const chat = chatData[chatId];
      document.getElementById("chat-title").textContent = chat.title;
      const chatLink = document.getElementById("chat-link");
      if (chat.url) {
        chatLink.href = chat.url;
        chatLink.style.display = "inline-flex";
      } else {
        chatLink.style.display = "none";
      }
      if (chat.messages && chat.messages.length > 0) {
        renderMessages(chat.messages);
      } else {
        document.getElementById("chat-content").innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comment-slash"></i>
          <p>${translations[localStorage.getItem('language') || 'en'].emptyState}</p>
        </div>`;
      }
      });
    
      // Save chatData globally for markdown toggle
      window.currentChatData = chatData;

      // Update the chat counter if defined
      document.getElementById("chat-counter-text").textContent = conversations.length + " " + translations[lang].chatCountSuffix;

      attachChatListClickHandler(chatData);
    }

    function setupMarkdownToggle() {
      // Initialize markdown toggle state - default to true (enabled)
      window.markdownEnabled = localStorage.getItem('markdownEnabled') !== 'false';
      const markdownToggle = document.getElementById('markdown-toggle');
      
      if (!markdownToggle) {
        console.error('Markdown toggle button not found!');
        return;
      }
      
      
      // Set initial checkbox state
      markdownToggle.checked = window.markdownEnabled;
      
      // Add markdown toggle event listener  
      markdownToggle.addEventListener('change', function(e) {
        window.markdownEnabled = e.target.checked;
        localStorage.setItem('markdownEnabled', window.markdownEnabled.toString());
        
        // Re-render current chat if one is selected
        const activeLi = document.querySelector(".chat-list li.active");
        if (activeLi && window.currentChatData) {
          const activeChatId = activeLi.getAttribute("data-id");
          renderMessages(window.currentChatData[activeChatId].messages);
        }
      });
    }

    function attachChatListClickHandler(chatData) {
      document.getElementById("chat-list").addEventListener("click", (event) => {
      const clickedLi = event.target.closest("li");
      if (!clickedLi) return;
      Array.from(document.getElementById("chat-list").children).forEach(li => {
        li.classList.remove("active");
      });
      clickedLi.classList.add("active");
      const chatId = clickedLi.getAttribute("data-id");
      const chat = chatData[chatId];
      document.getElementById("chat-title").textContent = chat.title;
      const lang = localStorage.getItem('language') || 'en';
      const chatLink = document.getElementById("chat-link");

      // Only show the link if there are messages
      if (chat.messages && chat.messages.length > 0) {
        if (chat.service === "Claude" && chat.uuid) {
        chatLink.href = "https://claude.ai/chat/" + chat.uuid;
        chatLink.innerHTML = '<i class="fas fa-external-link-alt"></i> ' + (translations[lang].viewOnClaude);
        chatLink.style.display = "inline-flex";
        } else if (chat.service === "ChatGPT" && chat.conversation_id) {
        chatLink.href = "https://chat.openai.com/c/" + chat.conversation_id;
        chatLink.innerHTML = '<i class="fas fa-external-link-alt"></i> ' + translations[lang].viewOnChatGPT;
        chatLink.style.display = "inline-flex";
        } else {
        chatLink.style.display = "none";
        }
      } else {
        chatLink.style.display = "none";
      }

      if (chat.messages && chat.messages.length > 0) {
        renderMessages(chat.messages);
      } else {
        document.getElementById("chat-content").innerHTML = `
        <div class="empty-state">
          <i class="fas fa-comment-slash"></i>
          <p>${translations[lang].emptyState}</p>
        </div>`;
      }
      });
    }

    // Handle the uploaded file (via input or drag & drop)
    function handleFile(file) {
      const loadingOverlay = document.getElementById('loading-overlay');
      const loadingBar = document.getElementById('loading-bar');
      loadingOverlay.style.display = 'block';
      const reader = new FileReader();
      reader.onprogress = (event) => {
      if (event.lengthComputable) {
        const percentLoaded = event.loaded / event.total;
        loadingBar.style.width = Math.floor(percentLoaded * 100) + '%';
      }
      };
      reader.onload = (event) => {
      try {
        const data = JSON.parse(event.target.result);
        document.getElementById('upload-wrapper').style.display = 'none';
        document.querySelector('.app-container').style.display = 'flex';
        loadingOverlay.style.display = 'none';
        processData(data);
        
        // Initialize markdown toggle after UI is shown
        setTimeout(() => {
          setupMarkdownToggle();
        }, 100);
      } catch (e) {
        const lang = localStorage.getItem('language') || 'en';
        alert(translations[lang].jsonParseError + e);
        loadingOverlay.style.display = 'none';
      }
      };
      reader.onerror = () => {
      const lang = localStorage.getItem('language') || 'en';
      alert(translations[lang].fileReadError);
      loadingOverlay.style.display = 'none';
      };
      reader.readAsText(file);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const uploadArea = document.getElementById('upload-area');
      const jsonFileInput = document.getElementById('json-file');
      uploadArea.addEventListener("click", () => {
      jsonFileInput.click();
      });
      uploadArea.addEventListener("dragover", (e) => {
      e.preventDefault();
      uploadArea.classList.add('hover');
      });
      uploadArea.addEventListener("dragleave", (e) => {
      e.preventDefault();
      uploadArea.classList.remove('hover');
      });
      uploadArea.addEventListener("drop", (e) => {
      e.preventDefault();
      uploadArea.classList.remove('hover');
      const files = e.dataTransfer.files;
      if (files.length) {
        handleFile(files[0]);
      }
      });
      jsonFileInput.addEventListener("change", (e) => {
      if (e.target.files.length) {
        handleFile(e.target.files[0]);
      }
      });
      // Modal: close by clicking the X
      document.querySelector("#settings-modal .close-button").addEventListener("click", () => {
      document.getElementById("settings-modal").style.display = "none";
      });
      // Open modal from settings
      document.getElementById("open-settings").addEventListener("click", () => {
      document.getElementById("settings-modal").style.display = "flex";
      });
      // Toggle dark mode in modal
      document.getElementById("modal-dark-toggle").addEventListener("change", (e) => {
      if (e.target.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
      }
      updateTranslations();
      });
      // Toggle chat position in modal
      document.getElementById("modal-chat-toggle").addEventListener("change", (e) => {
      if (e.target.checked) {
        localStorage.setItem('chatPosition', 'end');
      } else {
        localStorage.setItem('chatPosition', 'start');
      }
      const lang = localStorage.getItem('language') || 'en';
      document.getElementById("chat-position-text").textContent = e.target.checked ? translations[lang].chatPositionEnd : translations[lang].chatPositionStart;
      // If a chat is already displayed, update the scroll
      const chatContent = document.getElementById("chat-content");
      chatContent.scrollTop = e.target.checked ? chatContent.scrollHeight : 0;
      });
      // Handle language change
      document.getElementById("language-select").addEventListener("change", (e) => {
      localStorage.setItem('language', e.target.value);
      updateTranslations();
      });
      // Set saved settings from localStorage
      if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById("modal-dark-toggle").checked = true;
      }
      if (localStorage.getItem('chatPosition') === 'end') {
      document.getElementById("modal-chat-toggle").checked = true;
      document.getElementById("chat-position-text").textContent = translations[localStorage.getItem('language') || 'it'].chatPositionEnd;
      } else {
      document.getElementById("modal-chat-toggle").checked = false;
      document.getElementById("chat-position-text").textContent = translations[localStorage.getItem('language') || 'it'].chatPositionStart;
      }
      if (localStorage.getItem('language')) {
      document.getElementById("language-select").value = localStorage.getItem('language');
      } else {
      localStorage.setItem('language', 'en');
      }
      updateTranslations();
    });

    // Event for the share button: copy the chat title + ChatGPT/Claude link to clipboard
    document.getElementById("share-button").addEventListener("click", function() {
      const chatTitle = document.getElementById("chat-title").textContent;
      const chatLink = document.getElementById("chat-link").href;
      // Add a colon and a space between title and link
      const shareText = chatTitle + ": " + chatLink;
      navigator.clipboard.writeText(shareText).then(() => {
        const lang = localStorage.getItem('language') || 'en';
        // Create a small light gray message that appears and fades out slowly
        const notification = document.createElement("div");
        notification.id = "copy-notification";
        notification.textContent = translations[lang].copyNotification;
        notification.style.position = "fixed";
        //notification.style.bottom = "20px"; // Show the message at the bottom
        notification.style.top = "60px"; // Show the message at the top
        notification.style.left = "50%";
        notification.style.transform = "translateX(-50%)";
        notification.style.backgroundColor = "#ddd";
        notification.style.color = "#333";
        notification.style.padding = "10px 20px";
        notification.style.borderRadius = "4px";
        notification.style.opacity = "0";
        notification.style.transition = "opacity 1s";
        document.body.appendChild(notification);
        // Make the message appear
        setTimeout(() => {
        notification.style.opacity = "1";
        }, 10);
        // After 2 seconds, fade out and remove the element
        setTimeout(() => {
        notification.style.opacity = "0";
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 1000);
        }, 2000);
      }).catch(err => {
        const lang = localStorage.getItem('language') || 'en';
        console.error(translations[lang].copyError + ": " + err);
      });
    });
    
  </script>
</body>
</html>
